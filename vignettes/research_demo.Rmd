---
title: "Research demo"
author: "Richel Bilderbeek"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Research demo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This document describes my research. It does so by
showing the workflow for toy examples.

## Workflow

Every experiment has the following steps:

 * Creating parameter files
 * Simulate one incipient species tree per parameter file
 * Construct two species trees from an incipient species tree
 * Per species tree, simulate one or more alignments
 * Per alignment, let BEAST2 infer a posterior once or more often
 * Compare the species tree to the posterior species trees

## Creating parameter files

We will need to load some libraries:

```{r}
library(Cer2016)
library(ape)
options(warn = 2)
```


We create four parameter files:

```{r}
filenames <- paste0("research_demo_", 1:4, ".RDa")
```

Now the parameter files are created:

```{r}
create_test_parameter_files(filenames = filenames)
```

Here we can view them:

```{r}
knitr::kable(collect_parameters(filenames = filenames))
```

Note that they all have a different random number generator seed. Because
they do have different other parameters, this is no problem.


### Simulate one incipient species tree per parameter file

Here we simulate the 'true' incipient species tree:

```{r}
for (filename in filenames) {
  add_pbd_output(filename)  
}
```

These are the incipient species trees:

```{r fig.width = 7, fig.height = 7}
colors <- stats::setNames(c("gray", "black"), c("i", "g"))

for (filename in filenames) {
  testit::assert(is_valid_file(filename))
  testit::assert(length(read_file(filename)$pbd_output$igtree.extant$tip.label) > 0)
  print(filename)
  phytools::plotSimmap(
    read_file(filename)$pbd_output$igtree.extant, 
    colors = colors
  )
}
```

## Per incipient species tree, take the youngest and oldest representative per species

Per incipient species tree, we take the youngest and oldest representative per species:

```{r}
for (filename in filenames) {
  add_species_trees(filename)  
}
```

These are the phylogenies with one subspecies
per species:

```{r fig.width = 7, fig.height = 7}
for (filename in filenames) {
  print(filename)
  plot_species_tree(filename)
}
```

## Add alignments

```{r}
for (filename in filenames) {
  add_alignments(filename)  
}
```

```{r fig.width = 7, fig.height = 7}
for (filename in filenames) {
  print(filename)
  plot_alignments(filename)
}
```

## Add posteriors

```{r add_posteriors}
for (filename in filenames) {
  add_posteriors(
    filename, 
    skip_if_output_present = TRUE
  )
}
```

Let's view the two posteriors of the first two files:

```{r fig.width = 7, fig.height = 7}
plot_posterior_nltts(filenames[1])
plot_posterior_nltts(filenames[2])
```

The third and fourth parameter files have had two BEAST2 runs per alignment.
We can see how similar these are:

```{r fig.width = 7, fig.height = 7}
plot_posterior_nltts(filenames[3])
plot_posterior_nltts(filenames[4])
```

## nLTT statistics

```{r}
nltt_stats <- calc_nltt_stats_from_files(filenames = filenames)
nltt_stats$sti <- plyr::revalue(nltt_stats$sti, c("1"="youngest", "2"="oldest"))
knitr::kable(head(nltt_stats))
```

All on one heap:

```{r fig.width = 7, fig.height = 7}
ggplot2::ggplot(
  data = nltt_stats,
  ggplot2::aes(
    x = nltt_stats$filename,
    y = nltt_stats$nltt_stat
  )
) + ggplot2::geom_boxplot(
) + ggplot2::scale_x_discrete(
  name = "Filename"
) + ggplot2::scale_y_continuous(
  name = "nLTT statistic"
) + ggplot2::ggtitle("Distribution of nLTT statistics")

```

Seperated by species tree:

```{r fig.width = 7, fig.height = 7}
ggplot2::ggplot(
  data = nltt_stats,
  ggplot2::aes(
    x = nltt_stats$filename,
    y = nltt_stats$nltt_stat,
    color = nltt_stats$sti
  )
) + ggplot2::geom_boxplot(
) + ggplot2::scale_x_discrete(
  name = "Filename"
) + ggplot2::scale_y_continuous(
  name = "nLTT statistic"
) + ggplot2::ggtitle("Distribution of nLTT statistics")

```


```{r fig.width = 7, fig.height = 7}
phylogenies_11 <- Cer2016::get_posterior(file = read_file(filenames[1]), sti = 1, ai = 1, pi = 1)$trees
phylogenies_12 <- Cer2016::get_posterior(file = read_file(filenames[1]), sti = 2, ai = 1, pi = 1)$trees
phylogenies_21 <- Cer2016::get_posterior(file = read_file(filenames[2]), sti = 1, ai = 1, pi = 1)$trees
phylogenies_22 <- Cer2016::get_posterior(file = read_file(filenames[2]), sti = 2, ai = 1, pi = 1)$trees

class(phylogenies_11) <- "multiPhylo"
class(phylogenies_12) <- "multiPhylo"
class(phylogenies_21) <- "multiPhylo"
class(phylogenies_22) <- "multiPhylo"

phangorn::densiTree(
  phylogenies_11, 
  type = "cladogram", 
  alpha = 1
)

phangorn::densiTree(
  phylogenies_12, 
  type = "cladogram", 
  alpha = 1
)

phangorn::densiTree(
  phylogenies_21, 
  type = "cladogram", 
  alpha = 1
)

phangorn::densiTree(
  phylogenies_22, 
  type = "cladogram", 
  alpha = 1
)
```

## Cleaning up

```{r}
file.remove(filenames)
```
