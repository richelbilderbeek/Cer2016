---
title: "Research demo"
author: "Richel Bilderbeek"
date: "`r Sys.Date()`"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Research demo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This document describes my research. It does so by
showing the workflow for toy examples.

## Workflow

Every experiment has the following steps:
 * Starting up
 * Creating parameter files
 * Simulate one incipient species tree per parameter file
 * Once or more often, sample unique species from an incipient species tree
 * Per sampled species tree, add an outgroup
 * Simulate one or more alignments per species tree
 * Once or more often, let BEAST2 infer a posterior per alignment
 * Compare original, sampled species tree, to the posterior

## Starting up

We will need to load some libraries:

```{r}
library(Cer2016)
```

In this workflow, progress can and is shown. 
At the start of this document, we expect nothing:

```{r,cache=TRUE}
df <- check_progress()
knitr::kable(df)
```

Note that this result is cached. This is because if this
vignette is created/viewed multiple times, there *will*
be parameter files in present (note: blimey, this does not
appear to work perfectly).

## Creating parameter files

We create four parameter files:

```{r}
rng_seeds <- rep(x = 1, times = 4)
sirgs <- rep(0.5, times = 4)
siris <- rep(0.5, times = 4)
scrs <- rep(1.0, times = 4)
ergs <- rep(0.1, times = 4)
eris <- rep(0.1, times = 4)
ages <- rep(5, times = 4)
n_species_trees_sampleses <- c(1, 1, 2, 2)
mutation_rates <- rep(0.01, times = 4)
n_alignmentses <- c(1, 1, 2, 2)
sequence_lengths <- rep(1000, times = 4)
mcmc_chainlengths <- rep(10000, times = 4)
n_beast_runses <- c(1, 1, 2, 2)
filenames = c(
  "toy_example_1.RDa", 
  "toy_example_2.RDa", 
  "toy_example_3.RDa", 
  "toy_example_4.RDa"
)
for (i in seq(1, 4)) {
  save_parameters_to_file(
    rng_seed = rng_seeds[i],
    sirg = sirgs[i],
    siri = siris[i],
    scr = scrs[i],
    erg = ergs[i],
    eri = eris[i],
    age = ages[i],
    n_species_trees_samples = n_species_trees_sampleses[i],
    mutation_rate = mutation_rates[i],
    n_alignments = n_alignmentses[i],
    sequence_length = sequence_lengths[i],
    mcmc_chainlength = mcmc_chainlengths[i],
    n_beast_runs = n_beast_runses[i],
    filename = filenames[i]
  )  
}
```

Checking the progress:

```{r,cache=TRUE}
df <- check_progress()
knitr::kable(df)
```


### Do simulations

A simulation (including its replicates) can be run from the command line by supplying all the arguments to the R script 'do_simulation.R' (see chapter [sub:do_simulation.R]). This will result in:

 * A parameter file with intermediate data added
 * BEAST2 output files

### Analyze results

After the simulations, the results are analyzed with the R script 'do_analyze.R' (see chapter [sub:analyse.R]).

