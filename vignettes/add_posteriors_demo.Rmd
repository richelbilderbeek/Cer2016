---
title: "add_posteriors demo"
author: "Richel Bilderbeek"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{add_posteriors demo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Starting up

We will need to load some libraries:

```{r message = FALSE}
library(ape)
library(Cer2016)
library(ggplot2)
library(Hmisc)
library(nLTT)
library(ribir)
library(phangorn)
```

## Creating parameter files

Here, we create the four parameter filenames:

```{r}
filename <- "add_posterior_demo.RDa"
```

To be sure to have a fresh analysis, we delete the files if they exist:

```{r message = FALSE}
if (file.exists(filename)) {
  file.remove(filename)
}
```

Now the parameter files are created with the desired parameters:

```{r}
n_beast_runs <- 2

save_parameters_to_file(
  rng_seed = 2,
  sirg = 0.5,
  siri = 0.5,
  scr = 1.0e-1,
  erg = 0.1,
  eri = 0.1,
  age = 5,
  mutation_rate = 0.01,
  n_alignments = 1,
  sequence_length = 1000,
  mcmc_chainlength = 10000,
  n_beast_runs = n_beast_runs,
  filename = filename
)  
testit::assert(is_valid_file(filename))
```

## Running the simulation

The simulation has multiple steps. The last step is adding the 
posterior to the parameter file.

```{r}
do_simulation(filename, cache_beast_output = TRUE)
```

## Show the posterior

```{r}
posteriors <- get_posteriors(read_file(filename))
testit::assert(length(posteriors) == n_beast_runs)
testit::assert(is_posterior(posteriors[[1]][[1]]))
testit::assert(is_posterior(posteriors[[2]][[1]]))
phylogenies_1 <- posteriors[[1]][[1]]
phylogenies_2 <- posteriors[[2]][[1]]
testit::assert(length(phylogenies_1) > 0)
testit::assert(length(phylogenies_2) > 0)
```

Note the `[[index][[1]]` needed. Cumbersome as it is, R needs this to be able to store lists of phylogenies.
If you know something more elegant, please let me know.

Here another hack: to get the `densiTree` function working, phylogenies must be of class multiphylo.
Let it be so:

```{r}
class(phylogenies_1) <- "multiPhylo"
class(phylogenies_2) <- "multiPhylo"
```

Displaying first posterior:

```{r fig.width = 7, fig.height = 7}
phangorn::densiTree(
  phylogenies_1, 
  type = "cladogram", 
  alpha = 1
)
```

Displaying second posterior:

```{r fig.width = 7, fig.height = 7}
densiTree(
  phylogenies_2, 
  type = "cladogram", 
  alpha = 1
)
```

