---
title: "Analyse time"
author: "Richel Bilderbeek"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analyse time}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Load the library:

```{r}
library(Cer2016)
```

Set warnings to maximum level:

```{r}
options(warn = 2)
```

Read the collected times:

```{r}
time_data <- read_collected_times()
testit::assert(names(time_data) == c("per_file", "full_process"))
df_per_file <- time_data$per_file
df_process <- time_data$full_process
```

Show (part of) the times per file:

```{r}
knitr::kable(head(df_per_file))
```

Show (part of) the times for the whole process:

```{r}
knitr::kable(head(df_process))
```

See the effect of speciation initiation rate:

```{r fig.width = 7, fig.height = 7}
ggplot2::ggplot(
  df_per_file, 
  ggplot2::aes(
    x = as.factor(df_per_file$sirg), 
    y = df_per_file$add_posteriors_real_time_sec
  )
) + ggplot2::geom_boxplot() + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust = 0.5))
```

See the effect of speciation completion rate:

```{r fig.width = 7, fig.height = 7}
ggplot2::ggplot(
  df_per_file, 
  ggplot2::aes(
    x = as.factor(df_per_file$scr), 
    y = df_per_file$add_posteriors_real_time_sec
  )
) + ggplot2::geom_boxplot() + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust = 0.5))
```

See the effect of extinction rate:

```{r fig.width = 7, fig.height = 7}
ggplot2::ggplot(
  df_per_file, 
  ggplot2::aes(
    x = as.factor(df_per_file$erg), 
    y = df_per_file$add_posteriors_real_time_sec
  )
) + ggplot2::geom_boxplot() + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust = 0.5))
```

See effect of sequence length:

```{r fig.width = 7, fig.height = 7}
ggplot2::ggplot(
  df_per_file, 
  ggplot2::aes(
    x = as.factor(df_per_file$sequence_length), 
    y = df_per_file$add_posteriors_real_time_sec
  )
) + ggplot2::geom_boxplot() + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust = 0.5))
```

Collect some data to see the effect of number of taxa and sequence length:

```{r fig.width = 7, fig.height = 7}
df_n_taxa <- read_collected_n_taxa()
df_time_per_taxa <- merge(x = df_per_file, y = df_n_taxa, by = "filename", all = TRUE)

df_time_per_taxa <- df_time_per_taxa[
  !is.na(df_time_per_taxa$n_taxa) & !is.na(df_time_per_taxa$add_posteriors_real_time_sec), ]
```

See the effect of number of taxa:

```{r fig.width = 7, fig.height = 7}
ggplot2::ggplot(
  df_time_per_taxa, 
  ggplot2::aes(
    x = df_time_per_taxa$n_taxa, 
    y = df_time_per_taxa$add_posteriors_real_time_sec
  )
) + ggplot2::geom_point() + 
  ggplot2::geom_smooth() +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust = 0.5))

```

See the effect of number of taxa and sequence length:

```{r fig.width = 7, fig.height = 7}
ggplot2::ggplot(
  df_time_per_taxa, 
  ggplot2::aes(
    x = df_time_per_taxa$n_taxa, 
    y = df_time_per_taxa$add_posteriors_real_time_sec,
    color = as.factor(df_time_per_taxa$sequence_length)
  )
) + ggplot2::geom_point() + 
  ggplot2::geom_smooth() +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust = 0.5)) + 
  ggplot2::ggtitle("Effect of number of taxa and sequence length on calculation time") + 
  ggplot2::labs(colour = "Sequence length (base pairs)") +
  ggplot2::theme(legend.position = "bottom") +
  ggplot2::scale_x_continuous(name = "Number of taxa") +
  ggplot2::scale_y_continuous(name = "Time to create posterior (sec)")

```


Plot the variety between runs in a boxplot:

```{r fig.width = 7, fig.height = 7}
ggplot2::ggplot(
  df_process, 
  ggplot2::aes(
    x = df_process$process_name, 
    y = df_process$real_time_sec
  )
) + ggplot2::geom_boxplot() + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust = 0.5))
```

Aggregate by process:

```{r}
df_process <- stats::aggregate(df_process$real_time_sec, by = list(df_process$process_name), FUN=sum)
names(df_process) <- c("process_name", "real_time_sec")
knitr::kable(head(df_process))
```

Stacked bar:

```{r fig.width = 7, fig.height = 7}
ggplot2::ggplot(
  df_process, 
  ggplot2::aes(
    x = factor(""), 
    y = df_process$real_time_sec, 
    fill = df_process$process_name
  )
) + 
  ggplot2::geom_bar(stat = "identity") + 
  ggplot2::scale_x_discrete("") +
  ggplot2::ggtitle("Simulation times (sec)") + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust = 0.5))
```

Pie chart:

```{r fig.width = 7, fig.height = 7}
ggplot2::ggplot(
  df_process, 
  ggplot2::aes(
    x = factor(""), 
    y = df_process$real_time_sec, 
    fill = df_process$process_name
  )
) + 
  ggplot2::geom_bar(stat = "identity") + 
  ggplot2::scale_x_discrete("") +
  ggplot2::scale_y_continuous("time (sec)") +
  ggplot2::coord_polar(theta = "y") + 
  ggplot2::ggtitle("Simulation times")
```
