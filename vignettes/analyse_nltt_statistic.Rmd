---
title: "Analyse nLTT statistics"
author: "Richel Bilderbeek"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analyse nLTTs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Abstract

This vignette shows how analyse the nLTT statistics.

## Setup

Loading this package

```{r}
library(Cer2016)
options(warn = 2)
```

## Show the distribution of nLTT statistics

```{r}
nltt_stats_raw <- read_collected_nltt_stats()
nltt_stats_raw$sti <- plyr::revalue(nltt_stats_raw$sti, c("1"="youngest", "2"="oldest"))
knitr::kable(head(nltt_stats_raw))
```

Remove the NA's:

```{r}
nltt_stats <- nltt_stats_raw[!is.na(nltt_stats_raw$nltt_stat), ]
```

All on one heap:

```{r fig.width = 7, fig.height = 7}
ggplot2::ggplot(
  data = nltt_stats,
  ggplot2::aes(
    x = nltt_stats$filename,
    y = nltt_stats$nltt_stat
  )
) + ggplot2::geom_boxplot(
) + ggplot2::scale_x_discrete(
  name = "Filename"
) + ggplot2::scale_y_continuous(
  name = "nLTT statistic"
) + ggplot2::ggtitle("Distribution of nLTT statistics") + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust = 0.5)) + ggplot2::theme(legend.position="none") + 
  ggplot2::theme(axis.ticks = ggplot2::element_blank(), axis.text.x = ggplot2::element_blank())

```

Seperated by species tree, but still at one big heap:

```{r fig.width = 7, fig.height = 7}
ggplot2::ggplot(
  data = nltt_stats,
  ggplot2::aes(
    x = nltt_stats$sti,
    y = nltt_stats$nltt_stat
  )
) + ggplot2::geom_boxplot(
) + ggplot2::scale_x_discrete(
  name = "Filename"
) + ggplot2::scale_y_continuous(
  name = "nLTT statistic"
) + ggplot2::ggtitle("Distribution of nLTT statistics")

```

Time to anwer the question [do nLTT statistics differ between posteriors?](https://github.com/richelbilderbeek/Cer2016/issues/103)

First we need to know if nLTT statistics are normally 
distributed per posterior, as this will influence are tests.

To do, we will use the Shapiro-Wilk normality test, that
assumes all measured values are different.

First check the measurement that have only one
measured value:

```{r}
nltt_stats_all_equal <- dplyr::summarise(
  dplyr::group_by(nltt_stats, filename, sti, ai, pi),
  all_equal = (length(unique(nltt_stat)) == 1)
)
nltt_stats_all_equal <- nltt_stats_all_equal[ nltt_stats_all_equal$all_equal == TRUE, ]
knitr::kable(nltt_stats_all_equal)
```

Notice that all eight posteriors, independent of species tree,
alignment, or replicate, has all equal values.

```{r}
t <- dplyr::tally(dplyr::group_by(nltt_stats_all_equal, filename))
knitr::kable(t)
```

It is not the case that the error is too low to measure.
It is because two phylogenies with two taxa have an nLTT
statistic of exactly zero!

Back to the analysis:

How many nLTT statistics are distributed normally?

```{r}
df <- dplyr::summarise(
  dplyr::group_by(nltt_stats, filename, sti, ai, pi),
  idn = is_distributed_normally(nltt_stat)
)

knitr::kable(dplyr::tally(dplyr::group_by(df, idn)))
```



