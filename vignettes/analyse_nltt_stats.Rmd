---
title: "Analyse nLTT statistics"
author: "Richel Bilderbeek"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analyse nLTTs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Abstract

This vignette shows how analyse the nLTT statistics.

## Setup

Loading this package

```{r}
library(Cer2016)
#library(dplyr)
#library(tidyr)
options(warn = 2)
```

## Show the distribution of nLTT statistics

```{r}
nltt_stats_raw <- read_collected_nltt_stats()
#nltt_stats_raw$sti <- plyr::revalue(nltt_stats_raw$sti, c("1"="youngest", "2"="oldest"))
knitr::kable(head(nltt_stats_raw, 12))
```

Remove the NA's:

```{r}
#nltt_stats <- nltt_stats_raw
nltt_stats <- nltt_stats_raw[!is.na(nltt_stats_raw$nltt_stat), ]
```

## Are nLTT statistics from the same distribution?

Time to anwer the question [do nLTT statistics differ between posteriors?](https://github.com/richelbilderbeek/Cer2016/issues/103)

First we need to know if nLTT statistics are from the
same distribution, as this will influence are tests.

To do, we will use the Mann-Whitney U test, as
it assumes little.


### 2. Between alignments on same sampled species tree

```{r}
df_same_dist <- alignments_same_distr_nltt_stat(nltt_stats)
knitr::kable(head(df_same_dist))
knitr::kable(dplyr::count(df_same_dist, same_distr))
```

### 3. Between sampled species trees of same incipient species tree


### 1. Between BEAST2 runs on same DNA alignment

Are nLTT statistics between BEAST2 runs from the same
distribution?

```{r}
df_same_dist <- posteriors_same_distr_nltt_stat(nltt_stats)
knitr::kable(head(df_same_dist))
knitr::kable(dplyr::count(df_same_dist, same_distr))
```

Not all BEAST2 posteriors follow the same distribution.

```
df_true <- df[ !is.na(df$same_distr) & df$same_distr == TRUE, ]
df_false <- df[ !is.na(df$same_distr) & df$same_distr == FALSE, ]
df_na <- df[ is.na(df$same_distr), ]
testit::assert(nrow(df) == nrow(df_true) + nrow(df_false) + nrow(df_na))
```

Take a look at the parameter this happens under

```{r fig.width = 7, fig.height = 7}
df_parameters <- read_collected_parameters()
df_parameters$filename <- rownames(df_parameters)
df_n_taxa <- read_collected_n_taxa()

testit::assert("filename" %in% names(df_parameters))
testit::assert("filename" %in% names(df_n_taxa))
df <- merge(df_parameters, df_n_taxa, by = "filename")
names(df)

testit::assert("filename" %in% names(df))
testit::assert("filename" %in% names(df_same_dist))
df <- merge(df, df_same_dist, by = "filename")
testit::assert("filename" %in% names(df))
head(df)

df$same_distr <- plyr::mapvalues(df$same_distr, from = c(TRUE, FALSE, NA), to = c("yes", "no", "singular value"))


ggplot2::ggplot(
  data = df, ggplot2::aes(x = df$n_taxa, fill = df$same_distr)
) + ggplot2::scale_x_log10(
  "Number of taxa"
) + ggplot2::geom_histogram(
  bins = 20
) + ggplot2::ggtitle(
  "Are BEAST2 replicates from same distribution?"
) + ggplot2::guides(
  # Remove legend title
  fill = ggplot2::guide_legend(title = NULL) 
) + ggplot2::scale_y_continuous(
  "Number of posteriors"
)
```

#### How do the nLTT distributions look like?

First, the nLTTs of the posteriors that are different
distributed with the highest number of taxa:

```{r fig.width = 7, fig.height = 7}
# Collect the posteriors that have a nLTT statistics from\
# the same distribution
df_yes <- df[df$same_distr == "yes", ]

# Select of those posteriors the ones with the highest number
# of taxa
yes_max_n_taxa <- df_yes[
  df_yes$n_taxa == max(df_yes$n_taxa), 
]

# Obtain that first posterior its nLTT statistics
yes_max_n_taxa_nltts <- nltt_stats[ 
  nltt_stats$filename == yes_max_n_taxa[1, ]$filename & 
  nltt_stats$sti == yes_max_n_taxa[1, ]$sti & 
  nltt_stats$ai == yes_max_n_taxa[1, ]$ai, 
]

# Plot those nLTT statistics
# Histogram: nLTT distribution
# Solid line with fill: nLTT density
ggplot2::ggplot(
  yes_max_n_taxa_nltts, 
  ggplot2::aes(
    x = yes_max_n_taxa_nltts$nltt_stat, 
    fill = yes_max_n_taxa_nltts$pi
  )
) + ggplot2::geom_histogram(
  ggplot2::aes(
    y=..density..,
    fill = yes_max_n_taxa_nltts$pi
  )
) + ggplot2::geom_density(
  alpha=.2
) + ggplot2::ggtitle("nLTT statistics from same distribution"
)
```

I would like to see the nLTT statistics distribution of the two posteriors,
that are not from the same distribution

```{r fig.width = 7, fig.height = 7}
# Collect the posteriors that have a normally distributed
# nLTT statistic
df_no <- df[df$same_distr == "no", ]

# Select of those posteriors the ones with the highest number
# of taxa
no_max_n_taxa <- df_no[
  df_no$n_taxa == max(df_no$n_taxa), 
]

no_max_n_taxa_nltts <- nltt_stats[ 
  nltt_stats$filename == no_max_n_taxa[1, ]$filename & 
  nltt_stats$sti == no_max_n_taxa[1, ]$sti & 
  nltt_stats$ai == no_max_n_taxa[1, ]$ai, # Non't forget this comma
]

# Histogram: nLTT distribution
# Solid line with fill: nLTT density
ggplot2::ggplot(
  no_max_n_taxa_nltts, 
  ggplot2::aes(
    x = no_max_n_taxa_nltts$nltt_stat, 
    fill = no_max_n_taxa_nltts$pi
  )
) + ggplot2::geom_histogram(
  ggplot2::aes(
    y=..density..,
    fill = no_max_n_taxa_nltts$pi
  )
) + ggplot2::geom_density(
  alpha=.2
) + ggplot2::ggtitle("nLTT statistics from different distribution"
)
```

## Show all nLTTs

All on one heap:

```{r fig.width = 7, fig.height = 7}
if (1 == 2) {
  ggplot2::ggplot(
    data = nltt_stats,
    ggplot2::aes(
      x = nltt_stats$filename,
      y = nltt_stats$nltt_stat
    )
  ) + ggplot2::geom_boxplot(
  ) + ggplot2::scale_x_discrete(
    name = "Filename"
  ) + ggplot2::scale_y_continuous(
    name = "nLTT statistic"
  ) + ggplot2::ggtitle("Distribution of nLTT statistics") + 
    ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust = 0.5)) + ggplot2::theme(legend.position="none") + 
    ggplot2::theme(axis.ticks = ggplot2::element_blank(), axis.text.x = ggplot2::element_blank())
}
```
