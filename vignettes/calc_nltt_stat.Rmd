---
title: "Demonstration of calc_nltt_stat"
author: "Richel Bilderbeek"
date: "`r Sys.Date()`"
output: rmarkdown::pdf_document
vignette: >
  %\VignetteIndexEntry{Demonstration of calc_nltt_stat}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

`cal_nltt_stat` calculates the difference between original species tree and a posterior.

```{r}
library(Cer2016)
set.seed(42)
```

Here we determine the resolution of our analysis:

```{r}
dt <- 0.1
testit::assert(dt > 0.0 && dt < 1.0)
```

A `dt` (the timestep) close to zero gives a more detailed analysis, but it will take longer.

First we construct a possible species tree:

```{r}
species_tree <- ape::rcoal(n = 10)
phylogenies <- c(species_tree)
stree_nltts <- nLTT::get_nltt_values(
  phylogenies = phylogenies, 
  dt = dt
)
```

Then we collect four possible posterior species trees, of which one is equal the input phylogeny (and should have an error of zero):

```{r}
posteriors <- c(
  ape::rcoal(n = 10), 
  ape::rcoal(n = 10), 
  species_tree, 
  ape::rcoal(n = 10)
)
postr_nltts <- nLTT::get_nltt_values(phylogenies = posteriors, dt = dt)
```

Here we see the original species tree in black, and
the posteriors in other colors:

```{r fig.width = 7, fig.height = 7}
ggplot2::ggplot(
  data = stree_nltts,
  ggplot2::aes(x = stree_nltts$t, y = stree_nltts$nltt)
) + ggplot2::geom_step(
  direction = "vh",
  size = 2
) + ggplot2::geom_step(
  data = postr_nltts,
  ggplot2::aes(x = postr_nltts$t, y = postr_nltts$nltt,   colour = postr_nltts$id),
  direction = "vh",
  position = ggplot2::position_dodge(width = 0.02)
) + ggplot2::scale_x_continuous(
  limits = c(0, 1), breaks = seq(0, 1, 0.1), name = "Normalized time"
) + ggplot2::scale_y_continuous(
  limits = c(0, 1), breaks = seq(0, 1, 0.1), name = "nLTT"
) + ggplot2::ggtitle("True species tree nLTT and its posteriors")
```

The first step of `calc_nltt_stat` is to collect the difference of these two, by subtracting the nLTT values of the original species tree from each of the posteriors:

```{r}
diff_nltts <- postr_nltts
diff_nltts$nltt <- abs(diff_nltts$nltt - rep(stree_nltts$nltt, length(posteriors)))
```

Here we plot the differences, as boxplot:

```{r fig.width = 7, fig.height = 7}
ggplot2::ggplot(
  data = diff_nltts,
  ggplot2::aes(x = factor(diff_nltts$t), y = diff_nltts$nltt)
) + ggplot2::geom_boxplot(
) + ggplot2::scale_x_discrete(
  name = "Normalized time"
) + ggplot2::scale_y_continuous(
  limits = c(0, 1), breaks = seq(0, 1, 0.1), name = "nLTT difference"
) + ggplot2::ggtitle("Difference between true species tree nLTT and its posteriors")
```

`calc_nltt_stat` should now sum up those differences:

```{r}
nltt_stats <- dplyr::summarize(dplyr::group_by(diff_nltts, id), nltt_stat = mean(nltt))
```

Here are the four posterior values as four nice-looking bar-charts:

```{r}
ggplot2::ggplot(
  data = nltt_stats, 
  ggplot2::aes(x = nltt_stats$id, y = nltt_stats$nltt_stat, fill = nltt_stats$id)
) + ggplot2::geom_bar(stat = "identity", colour = "black"
) + ggplot2::scale_y_continuous(name = "nLTT statistic"
) + ggplot2::scale_x_discrete(name = "Posterior #"
) + ggplot2::ggtitle("Posterior nLTT statistic values")
```

This is the distribution of `nltt_stat`s, as a boxplot:

```{r}
ggplot2::ggplot(
  data = nltt_stats, 
  ggplot2::aes(x = 1, y = nltt_stats$nltt_stat)
) + ggplot2::geom_boxplot(
) + ggplot2::geom_point(color = nltt_stats$id
) + ggplot2::scale_y_continuous(name = "nLTT statistic"
) + ggplot2::scale_x_discrete(name = "The one posterior"
) + ggplot2::ggtitle("Posterior nLTT statistic distribution")
```



